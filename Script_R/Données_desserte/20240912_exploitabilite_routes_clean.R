# Chargement des librairies ----
library(readxl)
library(happign)
library(tmap)
library(sf)
library(dplyr)
library(terra)
tmap_mode("view")

# Importation des données cadastrales de la zone d'étude ----
Saxel_parca_pci <- get_apicarto_cadastre(
  x = "74261",               
  type = "parcelle",         
  source = "pci",            
  progress = TRUE            
)

# Re-projeter les données en Lambert 93 ----
Saxel_parca_pci_2154 <- st_transform(Saxel_parca_pci,
                                     crs = 2154
                                     )

# Calculer le buffer de 1 km autour des parcelles cadastrales ----
buffer_zone <- st_buffer(Saxel_parca_pci_2154,
                         dist = 1000
                         )

# Charger les routes dans la zone de buffer ----
routes <- get_wfs(buffer_zone,
                  "BDTOPO_V3:troncon_de_route",
                  spatial_filter = "intersects"
                  )

# Re-projeter les routes en Lambert 93 ----
routes_2154 <- st_transform(routes,
                            crs = 2154
                            )

# Calculer les effectifs pour chaque type de route dans la colonne 'nature' ----
nature_effectifs <- routes_2154 %>% 
  group_by(nature) %>% 
  summarise(nombre_routes = n()) %>% 
  arrange(desc(nombre_routes))

# Afficher le tableau dans la console
print(nature_effectifs)

# Filtrer les routes accessibles aux grumiers ----
grumier_routes <- routes_2154 %>%
  filter(nature %in% c("Route à 1 chaussée",
                       "Route empierrée"))

# Filtrer les routes accessibles aux skidders ----
pistes_skidders <- routes_2154 %>%
  filter(nature == "Chemin")

# Filtrer les sentiers ----
sentier_routes <- routes_2154 %>%
  filter(nature == "Sentier")

# Fonction optimisée pour vérifier la connectivité et exploitabilité ----
check_exploitability <- function(pistes_skidders,
                                 grumier_routes,
                                 sentier_routes) {
  
  # Créer un buffer pour les routes accessibles aux grumiers
  grumier_buffered <- st_buffer(grumier_routes,
                                dist = 5
                                )
  
  # Vérifier la connectivité entre pistes skidders et routes grumiers (directe)
  is_connected_direct <- st_intersects(pistes_skidders,
                                       grumier_buffered,
                                       sparse = FALSE
                                       )
  
  directly_connected <- rowSums(is_connected_direct) > 0
  
  directly_connected_skidders <- pistes_skidders[directly_connected, ]
  
  indirectly_connected_skidders <- pistes_skidders[!directly_connected, ]
  
  # Créer un buffer autour de tous les skidders connectés directement ou indirectement aux grumiers
  all_exploitables_skidders <- directly_connected_skidders
  
  # Utiliser une approche plus efficace pour l'expansion des chemins exploitables
  repeat {
    buffer_exploitables <- st_buffer(all_exploitables_skidders,
                                     dist = 5
                                     )
    
    is_connected_indirect <- st_intersects(indirectly_connected_skidders,
                                           buffer_exploitables,
                                           sparse = FALSE
                                           )
    newly_connected <- rowSums(is_connected_indirect) > 0
    newly_exploitables_skidders <- indirectly_connected_skidders[newly_connected,
                                                                 ]
    
    if (nrow(newly_exploitables_skidders) == 0) break
    
    all_exploitables_skidders <- rbind(all_exploitables_skidders,
                                       newly_exploitables_skidders
                                       )
    indirectly_connected_skidders <- indirectly_connected_skidders[!newly_connected, ]
  }
  
  non_exploitables_skidders <- indirectly_connected_skidders
  
  # Identification des intersections entre les chemins exploitables et les routes grumiers
  intersections <- st_intersection(all_exploitables_skidders,
                                   grumier_routes
                                   )
  place_de_depot <- st_collection_extract(intersections,
                                          type = "POINT"
                                          )
  
  # Créer la carte avec les éléments et afficher
  map_with_depots <- tm_shape(Saxel_parca_pci_2154) +
    tm_borders(col = "black",
               lwd = 1) +
    tm_shape(grumier_routes) + 
    tm_lines(col = "blue",
             lwd = 1.5,
             title.col = "Routes Grumiers") +
    tm_shape(all_exploitables_skidders) + 
    tm_lines(col = "green",
             lwd = 1,
             title.col = "Pistes Exploitables") +
    tm_shape(non_exploitables_skidders) + 
    tm_lines(col = "red",
             lwd = 1, title.col = "Routes Non Exploitables") +
    tm_shape(sentier_routes) + 
    tm_lines(col = "#808080",
             lwd = 1,
             title.col = "Sentiers") +
    tm_shape(place_de_depot) + 
    tm_dots(col = "yellow",
            size = 0.1,
            title = "Places de Depot") + 
    tm_layout(legend.outside = TRUE,
              legend.position = c("left", "bottom"),
              legend.title.size = 1, legend.text.size = 0.8)
  
  # Afficher la carte
  print(map_with_depots)
  
  # Retourner les chemins exploitables, non exploitables et les places de dépôt
  return(list(exploitables_skidders = all_exploitables_skidders, 
              non_exploitables = non_exploitables_skidders,
              place_de_depot = place_de_depot))
}

# Appeler la fonction pour vérifier l'exploitabilité
exploitability_results <- check_exploitability(pistes_skidders,
                                               grumier_routes,
                                               sentier_routes
                                               )

# Extraire les chemins exploitables, non exploitables et places de dépôt
exploitables_skidders <- exploitability_results$exploitables_skidders
non_exploitables <- exploitability_results$non_exploitables
place_de_depot <- exploitability_results$place_de_depot

# Afficher les détails des pistes non exploitables
print(non_exploitables)

# Sauvegarder les résultats dans le GeoPackage
gpkg1_path <- "projet_R_exploitabilitév1.gpkg"

# Définir une fonction pour sauvegarder une couche dans le GeoPackage ----
save_layer <- function(layer_data,
                       gpkg_path,
                       layer_name) {
  st_write(layer_data, gpkg_path,
           layer = layer_name,
           delete_layer = TRUE
           )
}

# Créer une liste de couches et de noms correspondants ----
layers_to_save <- list(
  "cadastre" = Saxel_parca_pci_2154,
  "troncons_routes" = routes_2154,
  "sentiers" = sentier_routes,
  "routes_grumiers" = grumier_routes,
  "chemins_exploitables" = exploitables_skidders,
  "chemins_non_exploitables" = non_exploitables,
  "place_de_depot" = place_de_depot
)

# Appliquer la fonction à chaque couche en utilisant une boucle ----
for (layer_name in names(layers_to_save)) {
  save_layer(layers_to_save[[layer_name]],
             gpkg1_path,
             layer_name
             )
}

# Afficher un message de confirmation ----
print("Toutes les couches ont été sauvegardées dans le fichier GeoPackage.")