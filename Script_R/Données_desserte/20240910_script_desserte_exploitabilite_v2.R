# Chargement des librairies ----
library(readxl)
library(happign)
library(tmap)
library(sf)
library(dplyr)
library(terra)
tmap_mode("view")

# Importation des données cadastrales de la zone d'étude ----
#nombres <- 1500:1600
#vecteur_chaine <- sprintf("%04d", nombres)

Saxel_parca_pci <- get_apicarto_cadastre(
  x = "74261",               
  type = "parcelle",         
  #section = "0A",            
  #numero = vecteur_chaine,   
  source = "pci",            
  progress = TRUE            
)

# Re-projeter les données en Lambert 93 ----
Saxel_parca_pci_2154 <- st_transform(Saxel_parca_pci,
                                     crs = 2154
                                     )

# Calculer le buffer de 1 km autour des parcelles cadastrales ----
buffer_zone <- st_buffer(Saxel_parca_pci_2154,
                         dist = 1000
                         )

# Charger les routes dans la zone de buffer ----
routes <- get_wfs(buffer_zone,
                  "BDTOPO_V3:troncon_de_route",
                  spatial_filter = "intersects"
                  )

# Re-projeter les routes en Lambert 93 ----
routes_2154 <- st_transform(routes,
                           crs = 2154
                           )

# Calculer les effectifs pour chaque type de route dans la colonne 'nature' ----
nature_effectifs <- routes_2154 %>%
  group_by(nature) %>%
  summarise(nombre_routes = n()) %>%
  arrange(desc(nombre_routes))

# Afficher le tableau dans la console
print(nature_effectifs)

# Filtrer les routes accessibles aux grumiers ----
grumier_routes <- routes_2154 %>% 
  filter(nature %in% c("Route à 1 chaussée",
                       "Route empierrée")
         )

# Filtrer les routes accessibles aux skidders
pistes_skidders <- routes_2154 %>%
  filter(nature == "Chemin")

# Filtrer les sentiers ----
sentier_routes <- routes_2154 %>%
  filter(nature == "Sentier")

# Fonction pour vérifier la connectivité exploitabilité V1----
check_exploitability <- function(pistes_skidders, grumier_routes) {
  # Créer un buffer pour les routes accessibles aux grumiers
  grumier_buffered <- st_buffer(grumier_routes, dist = 2) 
  # Buffer de 2 mètres pour la connectivité directe
  
  # Vérifier la connectivité directe entre skidders et routes grumiers
  is_connected_direct <- st_intersects(pistes_skidders,
                                       grumier_buffered,
                                       sparse = FALSE)
  
  # Identifier les skidders directement connectés
  directly_connected <- rowSums(is_connected_direct) > 0
  directly_connected_skidders <- pistes_skidders[directly_connected, ]
  
  # Identifier les skidders non connectés directement
  indirectly_connected_skidders <- pistes_skidders[!directly_connected, ]
  
  # Créer un buffer supplémentaire pour les skidders non directement connectés
  indirectly_connected_buffered <- st_buffer(indirectly_connected_skidders, dist = 1)
  
  # Vérifier la connectivité entre les skidders non connectés et les routes grumiers via un voisinage de 2 étapes
  is_connected_indirect <- st_intersects(indirectly_connected_buffered,
                                         grumier_buffered,
                                         sparse = FALSE
                                         )
  
  # Identifier les routes accessible aux skidders connectées indirectement
  indirectly_connected <- rowSums(is_connected_indirect) > 0
  
  # Union des routes accessible aux skidders directement et indirectement connectées
  exploitables_skidders <- rbind(directly_connected_skidders, indirectly_connected_skidders[indirectly_connected, ])
  
  # Carte des chemins exploitables et non exploitables ----
  map_exploitability <- tm_shape(Saxel_parca_pci_2154) +
    tm_borders(col = "black", lwd = 1) +
    tm_shape(grumier_routes) + 
    tm_lines(col = "blue", lwd = 1.5, legend.col.title = "Routes Grumiers") + 
    tm_shape(exploitables_skidders) + 
    tm_lines(col = "green", lwd = 1, legend.col.title = "Pistes Exploitables (Skidders)") + 
    tm_shape(pistes_skidders[!pistes_skidders$id %in% exploitables_skidders$id, ]) + 
    tm_lines(col = "red", lwd = 2, legend.col.title = "Pistes Non Exploitables") + 
    tm_shape(sentier_routes) + 
    tm_lines(col = "gray", lwd = 1, legend.col.title = "Sentiers") +
    tm_layout(legend.outside = TRUE, legend.position = c("left", "bottom"), legend.title.size = 1, legend.text.size = 0.8)
  
  # Afficher la carte
  print(map_exploitability)
  
  # Retourner la table des exploitables et non exploitables
  return(list(exploitables_skidders = exploitables_skidders, non_exploitables = pistes_skidders[!pistes_skidders$id %in% exploitables_skidders$id, ]))
}

# Appeler la fonction pour vérifier l'exploitabilité
exploitability_results <- check_exploitability(pistes_skidders,
                                               grumier_routes
                                               )

# Extraire les chemins exploitables et non exploitables
exploitables_skidders <- exploitability_results$exploitables_skidders
non_exploitables <- exploitability_results$non_exploitables

# Afficher les détails des pistes non exploitables
print(non_exploitables)

# Sauvegarder les résultats dans le GeoPackage
gpkg1_path <- "projet_R_exploitabilitév1.gpkg"

# Sauvegarder les couches dans le GeoPackage
st_write(Saxel_parca_pci_2154,
         gpkg1_path,
         layer = "cadastre",
         delete_layer = TRUE
         )

st_write(routes_2154,
         gpkg1_path,
         layer = "troncons_routes",
         delete_layer = TRUE
         )

# Sauvegarder les sentiers
st_write(sentier_routes,
         gpkg1_path,
         layer = "sentiers",
         delete_layer = TRUE
         )

# Sauvegarder les routes accessibles aux grumiers
st_write(grumier_routes,
         gpkg1_path,
         layer = "routes_grumiers",
         delete_layer = TRUE
         )

# Sauvegarder les chemins exploitables
st_write(exploitables_skidders,
         gpkg1_path,
         layer = "chemins_exploitables",
         delete_layer = TRUE
         )

# Sauvegarder les chemins non exploitables
st_write(non_exploitables,
         gpkg1_path,
         layer = "chemins_non_exploitables",
         delete_layer = TRUE
         )

# Afficher un message de confirmation
print("Les vecteurs ont été sauvegardés dans le fichier GeoPackage.")



# Fonction pour vérifier la connectivité exploitabilité V2 ----



# Carte des chemins exploitables et non exploitables (simplifiée) 
map_exploitability <- tm_shape(Saxel_parca_pci_2154) +
  tm_borders(col = "black", lwd = 1) +
  tm_shape(grumier_routes) + 
  tm_lines(col = "blue", lwd = 1.5, legend.col.title = "Routes Grumiers") + 
  tm_shape(pistes_skidders) + 
  tm_lines(col = "green", lwd = 1, legend.col.title = "Pistes Exploitables (Chemins)") + 
  tm_shape(sentier_routes) + 
  tm_lines(col = "gray", lwd = 1, legend.col.title = "Sentiers") +
  tm_layout(legend.outside = TRUE, legend.position = c("left", "bottom"), legend.title.size = 1, legend.text.size = 0.8)

# Afficher la carte
print(map_exploitability)




# Sauvegarder les résultats dans le GeoPackage
gpkg2_path <- "projet_R_exploitabilitév2.gpkg"

# Sauvegarder les couches dans le GeoPackage
st_write(Saxel_parca_pci_2154,
         gpkg1_path,
         layer = "cadastre",
         delete_layer = TRUE
         )

st_write(routes_2154,
         gpkg1_path,
         layer = "troncons_routes",
         delete_layer = TRUE
         )

# Sauvegarder les sentiers
st_write(sentier_routes,
         gpkg2_path,
         layer = "sentiers",
         delete_layer = TRUE
         )

# Sauvegarder les routes accessibles aux grumiers
st_write(grumier_routes,
         gpkg2_path,
         layer = "routes_grumiers",
         delete_layer = TRUE
         )

# Sauvegarder les chemins exploitables (tous les chemins)
st_write(skidder_routes,
         gpkg2_path,
         layer = "chemins_exploitables",
         delete_layer = TRUE
         )

# Afficher un message de confirmation
print("Les vecteurs ont été sauvegardés dans le fichier GeoPackage.")