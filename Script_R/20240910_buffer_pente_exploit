library(terra)
library(tmap)
library(sf)

# Fonction pour calculer la pente
calculate_slope <- function(mnt_path, output_path) {
  mnt <- rast(mnt_path)  # Lire le raster
  pente <- terrain(mnt, v = "slope", unit = "degrees")
  writeRaster(pente, filename = output_path, overwrite = TRUE)
  return(pente)
}

# Fonction pour créer des buffers autour des routes
create_buffers <- function(shape_route_path, distances) {
  shape_routes <- st_read(shape_route_path)
  shape_routes <- st_make_valid(shape_routes)
  
  buffers <- lapply(distances, function(dist) {
    buffer_file <- paste0("buffer_", dist, "m.shp")
    st_read(buffer_file)
  })
  
  return(buffers)
}

# Fonction pour créer la carte d'exploitabilité
create_exploitability_map <- function(shape_route_path, mnt_path, distances, output_slope_path) {
  
  # Créer des buffers autour des routes
  buffers <- create_buffers(shape_route_path, distances)
  
  # Calculer la pente
  pente <- calculate_slope(mnt_path, output_slope_path)
  
  # Reclassification de la pente
  reclass_matrix <- matrix(c(-Inf, 30, 1,  # Valeurs de pente <= 30 deviennent 1
                             30, Inf, 2), # Valeurs de pente > 30 deviennent 2
                           ncol = 3, byrow = TRUE)
  
  # Reclasser le raster
  pente_class <- classify(pente, reclass_matrix)
  
  # Convertir les rasters reclassifiés en polygones
  pente_class_polygons <- as.polygons(pente_class)
  
  # Séparer les polygones selon la classe
  praticable <- pente_class_polygons[pente_class_polygons$layer == 1, ]
  impraticable <- pente_class_polygons[pente_class_polygons$layer == 2, ]
  
  # Lire les buffers
  buffers_sf <- lapply(distances, function(dist) st_read(paste0("buffer_", dist, "m.shp")))
  
  # Visualiser les résultats avec tmap
  tmap_mode("view")  # Mode "view" pour une carte interactive
  
  # Création de la carte
  map <- tm_shape(praticable) + 
    tm_polygons(col = "lightgreen", border.col = "darkgreen", title = "Zones praticables") +
    tm_shape(impraticable) + 
    tm_polygons(col = "lightcoral", border.col = "darkred", title = "Zones impraticables")
  
  # Ajouter les buffers
  buffer_colors <- c("red", "green", "blue")
  for (i in 1:length(buffers_sf)) {
    map <- map + tm_shape(buffers_sf[[i]]) +
      tm_polygons(col = buffer_colors[i], border.col = buffer_colors[i], alpha = 0.5)  # Buffers semi-transparents
  }
  
  # Ajouter les routes
  shape_routes <- st_read

  
  
  
shape_route_path <- "C:/Users/louis/OneDrive/Documents/AgroParistech/3AA/Cours R/Projet_exploit/Couche_desserte.gpkg"
mnt_path <- "C:/Users/louis/OneDrive/Documents/AgroParistech/3AA/Cours R/Projet_exploit/Projet-R/Script_R/MNT_pente/mnt.tif"
distances <- c(20, 50, 100)
output_slope_path <- "C:/Users/louis/OneDrive/Documents/AgroParistech/3AA/Cours R/Projet_exploit/Projet-R/Résultats/exploit_text.tif"
create_exploitability_map(shape_route_path,mnt_path,distances,output_slope_path)  
  
